<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Darkhall</title>
    <style>
        #messages {
            margin-top: 50px;
            width: 95%;
            padding-right: 5px;
            padding-bottom: 80px;
            word-break: break-word;
        }

        #bottom-bar {
            position: fixed;
            bottom: 0px;
            width: 100%;
            height: 50px;
            padding-top: 13px;
            left: 0px;
            background-color: #cacaca;
        }

        .chat-message {
            margin-top: 5px;
        }


        #chat {
            width: 80%;
            resize: none;
            margin-left: 5px;
        }

        #send {
            width: 38px;
            height: 39px;
            border-radius: 72px;
            background-color: #0c48d1;
            border: none;
            margin-left: 7px;
        }

        #chat:active {
            border: none;
        }

        #send:active {
            border: none;
        }

        #header {
            position: fixed;
            width: 100%;
            height: 30px;
            background-color: #1e92bf;
            top: 0px;
            left: 0px;
            color: white;
            text-align: center;
            padding-top: 9px;
        }

            #header p {
                margin-top: 2px;
                font-family: arial;
            }

            #header a {
                color: white;
                text-decoration: none;
            }
    </style>

</head>
<body>

    <div id="header"><p>Altilunium Darkhall - <span id="bid"></span> <a href="https://rtnf.prose.sh/altilunium_darkhall" target="_blank"><small>[about]</small></a>  </p></div>
    <div id="messages" class="card-block"></div>

    <br>

    <div id="bottom-bar">
<textarea id="chat" name="inputMessage" maxlength="450"></textarea>
        <button id="send" class="btn"></button>
    </div>

</body>

<script src="gun.js"></script>
<script>
    var uid;

    if (localStorage.getItem('uid')) {
        uid = localStorage.getItem('uid')
    }
    else {
        uid = Math.floor(Math.random() * 100000);
        localStorage.setItem('uid',uid)
    }


    


    function findGetParameter(parameterName) {
        var result = null,
            tmp = [];
        location.search
            .substr(1)
            .split("&")
            .forEach(function (item) {
                tmp = item.split("=");
                if (tmp[0] === parameterName) result = decodeURIComponent(tmp[1]);
            });
        return result;
    }
    const bid = document.querySelector('#bid')

    console.log(findGetParameter("g"))
    var board = findGetParameter("g")
    console.log(board)
    if (board != null) {
        console.log("Ada!")
        bid.innerHTML = board
    } else {
        board = 'test'
        bid.innerHTML = "General Room"
    }


    gun = Gun(['https://rtnf-gun.herokuapp.com/gun']);
    copy = gun.get(board).get('chatlog');
    console.log(copy)
    var chatLog = []
    var identify = false
    //copy.put(null)
    copy.on((data) => {
        console.log(data)
        try {

            chatLog = JSON.parse(data)
            console.log(chatLog[0])

            if (!identify) {
                var today = new Date();
                var time = today.getHours() + ":" + today.getMinutes() 
                var c = "<small><i>" + uid + " is entering this room at " + time + "</i></small>"
                chatLog.push(c)
                copy.put(JSON.stringify(chatLog))
                identify = true
            }


            var mother = document.getElementById('messages')
            mother.innerHTML = ""
            chatLog.forEach(iter)

            function iter(v, i, a) {
                mother.innerHTML = mother.innerHTML + v +"<br>"
            }


        }
        catch (err) {
            chatLog = []
            var str = "<i>"+uid+" just cleared the chat log.</i>"
            chatLog.push(str)
            copy.put(JSON.stringify(chatLog))

        }


    });


    const send = document.querySelector('#send')
    const input = document.querySelector('#chat')
    send.onclick = () => {
        if (input.value == "clear") {
            copy.put(null)
        }
        else if (input.value.includes("<script>")) {

        }
        else {
            var c = "<b>" + uid + "</b> : " + input.value
            chatLog.push(c)
            copy.put(JSON.stringify(chatLog))
            package = board +" : "+ input.value
            logAct(package)
        }

        input.value = "";
        input.focus();



    };

    async function logAct(x) {
        const nyaa = await fetch("https://api.telegram.org/bot5405244499:AAGZwQ4ET0kBRJF9kBcuksyoc6I-Q5nSRAI/sendMessage?chat_id=-705800135&text=" + package);
    }


    window.addEventListener('beforeunload', (event) => {
        var today = new Date();
        var time = today.getHours() + ":" + today.getMinutes() 
        var c = "<small><i>" + uid + " is leaving this room at "+time+"</i></small>"
        chatLog.push(c)
        copy.put(JSON.stringify(chatLog))

        if (xhr.readyState == 4) return;
        event.preventDefault();
        event.returnValue = '';
    })




    //paste.oninput = () => { copy.put(paste.value) };
    //copy.on((data) => { paste.value = data });</script>
